{"version":3,"file":"/home/mikel/workspaces/bee/2017-global-hackaton/ng2-alfresco-aos-editonline/src/services/aos-edit-online-service.ts","sourceRoot":"","sources":["/home/mikel/workspaces/bee/2017-global-hackaton/ng2-alfresco-aos-editonline/src/services/aos-edit-online-service.ts"],"names":[],"mappings":"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","sourcesContent":[" import { Injectable } from '@angular/core';\n import { AlfrescoApiService,\n          LogService,\n          AlfrescoAuthenticationService,\n          NotificationService,\n          AlfrescoSettingsService \n   } from 'ng2-alfresco-core';\n\n @Injectable()\n export class AOSEditOnlineService {\n\n   constructor(\n     private alfrescoApiService: AlfrescoApiService,\n     private alfrescoAuthenticationService: AlfrescoAuthenticationService,\n     private alfrescoSettingsService: AlfrescoSettingsService,\n     private notificationService: NotificationService,\n     private logService: LogService\n     ) { }\n\n\n   getUserAgent(): string {\n     return navigator.userAgent.toLowerCase();\n   }\n\n   isWindows() {\n     return this.getUserAgent().indexOf('win') !== -1 ? true : false;\n   }\n\n   isMacOs() {\n     return this.getUserAgent().indexOf('mac') !== -1 ? true : false;\n   }\n\n   onActionEditOnlineAos(nodeId: string) {\n\n     let opts = {\n       include: [ 'isLocked', 'path' ]\n     };\n\n     this.alfrescoApiService.getInstance().core.nodesApi.getNode(nodeId, opts)\n      .then((data: any) => {\n        if (data) {\n            let node = data.entry;\n            if (node.isFile) {\n                if (node.isLocked) {\n                    let checkedOut = node.aspectNames.contains('cm:checkedOut');\n                    let lockOwner = node.properties['cm:lockOwner']; \n                    let differentLockOwner = lockOwner.id !== this.alfrescoAuthenticationService.getEcmUsername();\n\n                    if (checkedOut && differentLockOwner) { \n                        this.onAlreadyLockedNotification(node.id, lockOwner);\n                    } else {\n                        this.triggerEditOnlineAos(node);\n                    }\n                } else {\n                    this.triggerEditOnlineAos(node);\n                }\n            }\n        }\n      }, function (error) {\n         console.log('Error' + error);\n      });\n\n   }\n\n   private onAlreadyLockedNotification(nodeId: string, lockOwner: string) {\n     this.notificationService.openSnackMessage(\n       'document ' + nodeId \n       + ' locked by ' + lockOwner, 3000);\n   }\n\n   private triggerEditOnlineAos(node: any) {\n\n      let url = this.onlineEditUrlAos(node);\n      let fileExtension = node.name.split('.').pop() !== null ? node.name.split('.').pop().toLowerCase() : '';\n      let protocolHandler = this.getProtocolForFileExtension(fileExtension);\n\n       if (protocolHandler === undefined) {\n          this.notificationService.openSnackMessage('No protocol handler available for file extension', 3000);\n          return;\n       }\n\n       if (!this.isWindows() && !this.isMacOs()) {\n           this.notificationService.openSnackMessage('Aos only supported on Windows and Mac', 3000);\n           return;\n       } else {\n           this.aos_tryToLaunchOfficeByMsProtocolHandler(protocolHandler, url);\n       }\n\n       return;\n   }\n\n   private onlineEditUrlAos(node: any) {\n\n     let pathElements = node.path.elements.slice(1, node.path.elements.length);\n     let path = '/';\n     for (let element of pathElements) {\n         path = path + element.name + '/';\n     }\n\n     let url = this.alfrescoSettingsService.ecmHost + '/alfresco/aos' + path + '/' + node.name;\n     if (encodeURI(url).length > 256) {\n         url = this.alfrescoSettingsService.ecmHost + '/alfresco/aos/' + '_aos_nodeid' + '/' + node.id + '/' + node.name;\n     }\n     return url;\n    }\n\n    private getProtocolForFileExtension(fileExtension: string) {\n         let msProtocolNames = {\n            'doc'  : 'ms-word',\n            'docx' : 'ms-word',\n            'docm' : 'ms-word',\n            'dot'  : 'ms-word',\n            'dotx' : 'ms-word',\n            'dotm' : 'ms-word',\n            'xls'  : 'ms-excel',\n            'xlsx' : 'ms-excel',\n            'xlsb' : 'ms-excel',\n            'xlsm' : 'ms-excel',\n            'xlt'  : 'ms-excel',\n            'xltx' : 'ms-excel',\n            'xltm' : 'ms-excel',\n            'ppt'  : 'ms-powerpoint',\n            'pptx' : 'ms-powerpoint',\n            'pot'  : 'ms-powerpoint',\n            'potx' : 'ms-powerpoint',\n            'potm' : 'ms-powerpoint',\n            'pptm' : 'ms-powerpoint',\n            'pps'  : 'ms-powerpoint',\n            'ppsx' : 'ms-powerpoint',\n            'ppam' : 'ms-powerpoint',\n            'ppsm' : 'ms-powerpoint',\n            'sldx' : 'ms-powerpoint',\n            'sldm' : 'ms-powerpoint'\n         };\n         return msProtocolNames[fileExtension];\n    }\n\n    private aos_tryToLaunchOfficeByMsProtocolHandler(protocolHandler: string, url: string) {\n          let protocolUrl = protocolHandler + ':ofe%7Cu%7C' + url;\n          let protocolHandlerPresent = false;\n\n          let input = document.createElement('input');\n          let inputTop = document.body.scrollTop + 10;\n          input.setAttribute('style', 'z-index: 1000; background-color: rgba(0, 0, 0, 0); border: none; outline: none; position: absolute; left: 10px; top: ' + inputTop + 'px;');\n          document.getElementsByTagName('body')[0].appendChild(input);\n          input.focus();\n          input.onblur = function() {\n              protocolHandlerPresent = true;\n          };\n          location.href = protocolUrl;\n          let that = this;\n          setTimeout(function() {\n              input.onblur = null;\n              input.remove();\n              if (!protocolHandlerPresent) {\n                  that.notificationService.openSnackMessage('unsupported version of Office', 3000);\n              }\n          }, 500);\n    }\n\n }\n\n"]}